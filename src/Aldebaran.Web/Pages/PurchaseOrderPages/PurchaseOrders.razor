@page "/purchase-orders"
@page "/purchase-orders/{PURCHASE_ORDER_ID}"
@attribute [Authorize(Roles = "Admin,Purchase Order Viwer,Purchase Order Editor")]
@using Aldebaran.Web.Resources.LocalizedControls;
@using ServiceModel = Aldebaran.Application.Services.Models;
@inject Aldebaran.Web.Resources.ISharedStringLocalizer SharedLocalizer

<PageTitle>Ordenes de compra</PageTitle>
<RadzenStack>
    @if (DialogResult != null && DialogResult.Success)
    {
        <RadzenAlert Shade="Shade.Lighter" @bind-Visible="DialogResult.Visible" Variant="Variant.Flat" Size="AlertSize.Small" AlertStyle="AlertStyle.Success">@DialogResult.Message</RadzenAlert>
    }
    @if (DialogResult != null && !DialogResult.Success)
    {
        <RadzenAlert Shade="Shade.Lighter" @bind-Visible="DialogResult.Visible" Variant="Variant.Flat" Size="AlertSize.Small" AlertStyle="AlertStyle.Danger">@DialogResult.Message</RadzenAlert>
    }
    <RadzenRow AlignItems="AlignItems.Center">
        <RadzenColumn Size="12">
            <RadzenText Text="Ordenes de compra" TextStyle="TextStyle.H3" TagName="TagName.H1" style="margin: 0" />
        </RadzenColumn>
        <RadzenColumn Size="12">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start" Gap="0.5rem">
                <RadzenButton Icon="add_circle_outline" Text="Nuevo" Click="@AddPurchaseOrder" Variant="Variant.Flat" />
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
    <RadzenTextBox Placeholder="Buscar ..." style="display: block; width: 100%" @oninput="@Search" />
    <RadzenRow>
        <RadzenColumn SizeMD=12>
            <LocalizedDataGrid @ref="PurchaseOrderGrid" ColumnWidth="200px" AllowFiltering="true" FilterMode="FilterMode.Advanced" AllowPaging="true" AllowSorting="true" ShowPagingSummary="true" PageSizeOptions=@(new int[]{5, 10, 20, 30})
                               Data="@PurchaseOrdersList" TItem="ServiceModel.PurchaseOrder" RowExpand=@GetChildData AllowColumnPicking="true" AllowColumnResize="true" AllowMultiColumnSorting="true" ExpandMode="Radzen.DataGridExpandMode.Single" AllowGrouping="true" AllowColumnReorder="true">
                <Columns>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="OrderNumber" Title="Número de orden">
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="CreationDate" Title="Fecha de creación" Visible="false">
                        <Template Context="purchaseOrder">
                            <span>@purchaseOrder.CreationDate.ToString(SharedLocalizer["date:format"])</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="RequestDate" Title="Fecha de solicitud">
                        <Template Context="purchaseOrder">
                            <span>@purchaseOrder.RequestDate.ToString(SharedLocalizer["date:format"])</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="ExpectedReceiptDate" Title="Fecha esperada de recepción">
                        <Template Context="purchaseOrder">
                            <span>@purchaseOrder.ExpectedReceiptDate.ToString(SharedLocalizer["date:format"])</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="RealReceiptDate" Title="Fecha real de recepción">
                        <Template Context="purchaseOrder">
                            <span>@purchaseOrder.RealReceiptDate?.ToString(SharedLocalizer["date:format"])</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="StatusDocumentType.StatusDocumentTypeName" Title="Estado">
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="ImportNumber" Title="Número de importación" Visible="false">
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="EmbarkationPort" Title="Puerto de embarcación" Visible="false">
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="ProformaNumber" Title="Número de proforma" Visible="false">
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="Provider.ProviderName" Title="Proveedor">
                        <Template Context="purchaseOrder">
                            <span>(@purchaseOrder.ForwarderAgent.Forwarder.ForwarderName) @purchaseOrder.ForwarderAgent.ForwarderAgentName</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Property="ShipmentForwarderAgentMethodId" Title="Método de envío">
                        <Template Context="purchaseOrder">
                            <span>@purchaseOrder.ShipmentForwarderAgentMethod.ShipmentMethod.ShipmentMethodName</span>
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrder" Filterable="false" Sortable="false" Width="70px" TextAlign="TextAlign.Center" Pickable="false" Reorderable="false" Frozen="true" Groupable="false">
                        <Template Context="purchaseOrder">
                            <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Size="ButtonSize.Medium"
                                          Shade="Shade.Lighter" Variant="Variant.Flat"
                                          Click=@(args => DeletePurchaseOrder(args, purchaseOrder)) @onclick:stopPropagation="true" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
                <Template Context="purchaseOrder">
                    <RadzenTabs SelectedIndex="0">
                        <Tabs>
                            <RadzenTabsItem Text="Detalle de la orden de compra">
                                <RadzenStack>
                                    <RadzenRow Gap="0" AlignItems="AlignItems.Center">
                                        <RadzenColumn Size="12">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start" Gap="0.5rem">
                                                <RadzenButton Visible="@(purchaseOrder != null)" Icon="add_circle_outline" Text="Nuevo" Click=@(args => AddPurchaseOrderDetail(args,purchaseOrder)) />
                                            </RadzenStack>
                                        </RadzenColumn>
                                    </RadzenRow>
                                    <LocalizedDataGrid ColumnWidth="200px" Visible="@(purchaseOrder != null)" @ref=PurchaseOrderDetailsDataGrid AllowFiltering="true" FilterMode="Radzen.FilterMode.Advanced" AllowPaging="true" AllowSorting="true" ShowPagingSummary="true" PageSizeOptions=@(new int[]{5, 10, 20, 30})
                                                       Data="@purchaseOrder?.PurchaseOrderDetails" TItem="ServiceModel.PurchaseOrderDetail">
                                        <Columns>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderDetail" Property="RequestedQuantity" Title="Cantidad solicitada">
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderDetail" Property="ReceivedQuantity" Title="Cantidad recibida">
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderDetail" Property="ItemReference.Item.Line.LineName" Title="Línea" />
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderDetail" Title="Artículo">
                                                <Template Context="detail">
                                                    <span>(@detail.ItemReference.Item.InternalReference) @detail.ItemReference.Item.ItemName</span>
                                                </Template>
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderDetail" Title="Referencia">
                                                <Template Context="detail">
                                                    <span>(@detail.ItemReference.ReferenceCode) @detail.ItemReference.ReferenceName</span>
                                                </Template>
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderDetail" Property="Warehouse.WarehouseName" Title="Bodega">
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderDetail" Filterable="false" Sortable="false" Width="70px" TextAlign="TextAlign.Center">
                                                <Template Context="detail">
                                                    <RadzenButton ButtonStyle="ButtonStyle.Light" Icon="edit" Size="ButtonSize.Medium" Variant="Variant.Flat"
                                                                  Click=@(args => EditPurchaseOrderDetail(detail,purchaseOrder)) @onclick:stopPropagation="true" />
                                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Size="ButtonSize.Medium" Shade="Shade.Lighter" Variant="Variant.Flat"
                                                                  Click=@(args => DeletePurchaseOrderDetail(args, detail)) @onclick:stopPropagation="true" />
                                                </Template>
                                            </RadzenDataGridColumn>
                                        </Columns>
                                    </LocalizedDataGrid>
                                </RadzenStack>
                            </RadzenTabsItem>
                            <RadzenTabsItem Text="Actividades">
                                <RadzenStack>
                                    <RadzenRow Gap="0" AlignItems="AlignItems.Center">
                                        <RadzenColumn Size="12">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start" Gap="0.5rem">
                                                <RadzenButton Visible="@(purchaseOrder != null)" Icon="add_circle_outline" Text="Nuevo" Click=@(args => AddPurchaseOrderActivity(args,purchaseOrder)) />
                                            </RadzenStack>
                                        </RadzenColumn>
                                    </RadzenRow>
                                    <LocalizedDataGrid ColumnWidth="200px" Visible="@(purchaseOrder != null)" @ref=PurchaseOrderActivitiesDataGrid AllowFiltering="true" FilterMode="Radzen.FilterMode.Advanced" AllowPaging="true" AllowSorting="true" ShowPagingSummary="true" PageSizeOptions=@(new int[]{5, 10, 20, 30})
                                                       Data="@purchaseOrder?.PurchaseOrderActivities" TItem="ServiceModel.PurchaseOrderActivity">
                                        <Columns>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderActivity" Title="Creado por" Width="300px">
                                                <Template Context="activity">
                                                    <span>(@activity.Employee.Area.AreaName) @activity.ActivityEmployee.FullName</span>
                                                </Template>
                                            </RadzenDataGridColumn>

                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderActivity" Title="Responsable" Width="300px">
                                                <Template Context="activity">
                                                    <span>(@activity.ActivityEmployee.Area.AreaName) @activity.ActivityEmployee.FullName</span>
                                                </Template>
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderActivity" Title="Fecha de ejecución">
                                                <Template Context="activity">
                                                    <span>@activity.ExecutionDate.ToString(SharedLocalizer["date:format"])</span>
                                                </Template>
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderActivity" Property="ActivityDescription" Title="Actividad">
                                            </RadzenDataGridColumn>
                                            <RadzenDataGridColumn TItem="ServiceModel.PurchaseOrderActivity" Filterable="false" Sortable="false" Width="70px" TextAlign="TextAlign.Center">
                                                <Template Context="activity">
                                                    <RadzenButton ButtonStyle="ButtonStyle.Light" Icon="edit" Size="ButtonSize.Medium" Variant="Variant.Flat"
                                                                  Click=@(args => EditPurchaseOrderActivity(activity,purchaseOrder)) @onclick:stopPropagation="true" />
                                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Size="ButtonSize.Medium" Shade="Shade.Lighter" Variant="Variant.Flat"
                                                                  Click=@(args => DeletePurchaseOrderActivity(args, activity)) @onclick:stopPropagation="true" />
                                                </Template>
                                            </RadzenDataGridColumn>
                                        </Columns>
                                    </LocalizedDataGrid>
                                </RadzenStack>
                            </RadzenTabsItem>
                        </Tabs>
                    </RadzenTabs>
                </Template>
            </LocalizedDataGrid>

        </RadzenColumn>
    </RadzenRow>
</RadzenStack>
